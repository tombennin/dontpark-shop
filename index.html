<!DOCTYPE html>
<html>
<head>
    <title>DontPark.ai - CDN-Free Version</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
        .box { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; }
        .success { border-left: 5px solid green; }
        .error { border-left: 5px solid red; }
        .warning { border-left: 5px solid orange; }
        button { padding: 10px 20px; background: blue; color: white; border: none; border-radius: 4px; margin: 5px; }
    </style>
</head>
<body>
    <h1>üöÄ DontPark.ai - Working Version (No CDN)</h1>
    
    <div class="box success">
        <h3>‚úÖ Status: CDN-Free Mode Active</h3>
        <p>Using built-in Supabase client (no external dependencies)</p>
    </div>
    
    <div class="box" id="connectionTest">
        <h3>Database Connection Test</h3>
        <p id="connectionStatus">Testing connection...</p>
        <button onclick="testConnection()">Test Now</button>
        <button onclick="createTestBooking()">Create Test Booking</button>
        <button onclick="loadBookings()">Load Bookings</button>
    </div>
    
    <div class="box">
        <h3>Today's Stats</h3>
        <div id="stats">
            <div>üìä Bookings Today: <span id="todayCount">-</span></div>
            <div>üí∞ Revenue Today: <span id="todayRevenue">-</span></div>
            <div>üìà Total Bookings: <span id="totalCount">-</span></div>
        </div>
    </div>
    
    <div class="box">
        <h3>Recent Bookings</h3>
        <div id="bookingsList">Loading...</div>
    </div>
    
    <div class="box">
        <h3>Debug Log</h3>
        <div id="debugLog" style="background: #f5f5f5; padding: 10px; font-family: monospace; white-space: pre-wrap; max-height: 200px; overflow-y: auto;"></div>
    </div>

    <script>
        // Built-in Supabase client (no CDN required)
        class SimpleSupabaseClient {
            constructor(url, key) {
                this.url = url;
                this.key = key;
                this.headers = {
                    'apikey': key,
                    'Authorization': `Bearer ${key}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                };
            }
            
            from(table) {
                return new SupabaseTable(this.url, this.headers, table);
            }
        }
        
        class SupabaseTable {
            constructor(baseUrl, headers, table) {
                this.baseUrl = baseUrl;
                this.headers = headers;
                this.table = table;
            }
            
            select(columns = '*') {
                return new SupabaseQuery(this.baseUrl, this.headers, this.table, 'SELECT', columns);
            }
            
            insert(data) {
                return new SupabaseQuery(this.baseUrl, this.headers, this.table, 'INSERT', '*', data);
            }
            
            update(data) {
                return new SupabaseQuery(this.baseUrl, this.headers, this.table, 'UPDATE', '*', data);
            }
            
            delete() {
                return new SupabaseQuery(this.baseUrl, this.headers, this.table, 'DELETE');
            }
        }
        
        class SupabaseQuery {
            constructor(baseUrl, headers, table, method, columns = '*', data = null) {
                this.baseUrl = baseUrl;
                this.headers = headers;
                this.table = table;
                this.method = method;
                this.columns = columns;
                this.data = data;
                this.filters = [];
                this.orderBy = null;
                this.limitCount = null;
            }
            
            eq(column, value) {
                this.filters.push(`${column}=eq.${value}`);
                return this;
            }
            
            order(column, options = {}) {
                const direction = options.ascending === false ? 'desc' : 'asc';
                this.orderBy = `${column}.${direction}`;
                return this;
            }
            
            limit(count) {
                this.limitCount = count;
                return this;
            }
            
            async execute() {
                try {
                    const url = `${this.baseUrl}/rest/v1/${this.table}`;
                    const params = new URLSearchParams();
                    
                    if (this.method === 'SELECT') {
                        if (this.columns !== '*') params.append('select', this.columns);
                        this.filters.forEach(filter => {
                            const [key, value] = filter.split('=');
                            params.append(key, value);
                        });
                        if (this.orderBy) params.append('order', this.orderBy);
                        if (this.limitCount) params.append('limit', this.limitCount);
                    }
                    
                    const queryString = params.toString();
                    const fetchUrl = queryString ? `${url}?${queryString}` : url;
                    
                    const options = {
                        method: this.method === 'SELECT' ? 'GET' : 
                               this.method === 'INSERT' ? 'POST' :
                               this.method === 'UPDATE' ? 'PATCH' : 'DELETE',
                        headers: this.headers
                    };
                    
                    if (this.data && (this.method === 'INSERT' || this.method === 'UPDATE')) {
                        options.body = JSON.stringify(this.data);
                    }
                    
                    log(`Making ${options.method} request to: ${fetchUrl}`);
                    
                    const response = await fetch(fetchUrl, options);
                    const result = await response.text();
                    
                    if (!response.ok) {
                        let errorData;
                        try {
                            errorData = JSON.parse(result);
                        } catch {
                            errorData = { message: result || 'Unknown error' };
                        }
                        return { data: null, error: errorData };
                    }
                    
                    let data = null;
                    if (result) {
                        try {
                            data = JSON.parse(result);
                        } catch {
                            data = result;
                        }
                    }
                    
                    return { data, error: null };
                    
                } catch (error) {
                    return { data: null, error: { message: error.message } };
                }
            }
        }
        
        // Initialize our custom Supabase client
        const supabase = new SimpleSupabaseClient(
            'https://uhrhukcovvvbmopvoncr.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVocmh1a2NvdnZ2Ym1vcHZvbmNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MzIyMzcsImV4cCI6MjA3MDEwODIzN30.Ce69ktLB8h_OMe0H1XpDmRjKZawGlb59ProIs8UEaRw'
        );
        
        // Utility functions
        const debugLog = document.getElementById('debugLog');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            console.log(logMessage);
            debugLog.textContent += logMessage + '\n';
            debugLog.scrollTop = debugLog.scrollHeight;
        }
        
        function updateStatus(elementId, message, isSuccess = true) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.color = isSuccess ? 'green' : 'red';
        }
        
        // Main functions
        async function testConnection() {
            log('üß™ Testing database connection...');
            updateStatus('connectionStatus', 'Testing...', true);
            
            try {
                const { data, error } = await supabase
                    .from('bookings')
                    .select('count')
                    .limit(1)
                    .execute();
                
                if (error) {
                    log(`‚ùå Connection failed: ${error.message}`);
                    updateStatus('connectionStatus', `‚ùå Connection failed: ${error.message}`, false);
                } else {
                    log('‚úÖ Database connection successful!');
                    updateStatus('connectionStatus', '‚úÖ Database connected successfully!', true);
                    loadStats();
                }
            } catch (error) {
                log(`‚ùå Connection error: ${error.message}`);
                updateStatus('connectionStatus', `‚ùå Error: ${error.message}`, false);
            }
        }
        
        async function loadBookings() {
            log('üìä Loading bookings...');
            
            try {
                const { data, error } = await supabase
                    .from('bookings')
                    .select('*')
                    .order('created_at')
                    .limit(5)
                    .execute();
                
                if (error) {
                    log(`‚ùå Error loading bookings: ${error.message}`);
                    document.getElementById('bookingsList').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
                } else {
                    log(`‚úÖ Loaded ${data?.length || 0} bookings`);
                    displayBookings(data || []);
                }
            } catch (error) {
                log(`‚ùå Exception loading bookings: ${error.message}`);
                document.getElementById('bookingsList').innerHTML = `<p style="color: red;">Exception: ${error.message}</p>`;
            }
        }
        
        async function createTestBooking() {
            log('‚ûï Creating test booking...');
            
            const testBooking = {
                customer_name: 'Test Customer ' + Math.floor(Math.random() * 1000),
                vehicle_info: '2020 Test Car',
                issue_description: 'Test issue created at ' + new Date().toLocaleString(),
                flight_info: 'TEST' + Math.floor(Math.random() * 1000),
                status: 'new',
                created_at: new Date().toISOString()
            };
            
            try {
                const { data, error } = await supabase
                    .from('bookings')
                    .insert([testBooking])
                    .execute();
                
                if (error) {
                    log(`‚ùå Error creating booking: ${error.message}`);
                    alert(`Error: ${error.message}`);
                } else {
                    log('‚úÖ Test booking created successfully!');
                    alert('‚úÖ Test booking created!');
                    loadBookings();
                    loadStats();
                }
            } catch (error) {
                log(`‚ùå Exception creating booking: ${error.message}`);
                alert(`Exception: ${error.message}`);
            }
        }
        
        async function loadStats() {
            try {
                const { data, error } = await supabase
                    .from('bookings')
                    .select('*')
                    .execute();
                
                if (error) {
                    log(`‚ùå Error loading stats: ${error.message}`);
                } else {
                    const total = data?.length || 0;
                    const today = new Date().toISOString().split('T')[0];
                    const todayBookings = data?.filter(b => b.created_at?.startsWith(today)) || [];
                    
                    document.getElementById('totalCount').textContent = total;
                    document.getElementById('todayCount').textContent = todayBookings.length;
                    document.getElementById('todayRevenue').textContent = '$' + (todayBookings.length * 280);
                    
                    log(`üìä Stats updated: ${total} total, ${todayBookings.length} today`);
                }
            } catch (error) {
                log(`‚ùå Stats error: ${error.message}`);
            }
        }
        
        function displayBookings(bookings) {
            const container = document.getElementById('bookingsList');
            
            if (!bookings || bookings.length === 0) {
                container.innerHTML = '<p>No bookings found. Try creating a test booking!</p>';
                return;
            }
            
            const html = bookings.map(booking => `
                <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 4px;">
                    <strong>${booking.customer_name || 'Unknown'}</strong><br>
                    <small>${booking.vehicle_info || 'No vehicle info'}</small><br>
                    <em>${booking.issue_description || 'No description'}</em><br>
                    <span style="color: #666;">Status: ${booking.status || 'unknown'}</span>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        // Initialize
        log('üöÄ DontPark.ai CDN-Free version loaded');
        log('‚úÖ Custom Supabase client ready');
        
        // Auto-test connection on load
        setTimeout(testConnection, 1000);
    </script>
</body>
</html>
